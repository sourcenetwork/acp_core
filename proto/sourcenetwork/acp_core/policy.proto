syntax = "proto3";

package sourcenetwork.acp_core;

import "google/protobuf/timestamp.proto";

import "sourcenetwork/acp_core/specification.proto";

option go_package = "github.com/sourcenetwork/acp_core/pkg/types";

// PolicyEncodingType enumerates supported marshaling types for policies.
enum PolicyMarshalingType {
  // Fallback value for a missing Marshaling Type
  UNKNOWN = 0;

  // YAML Marshaled Policy
  YAML = 1;
}

// Policy represents an ACP module Policy definition.
// Each Policy defines a set of high level rules over how the acces control system
// should behave.
message Policy {
  string id = 1;
  string name = 2;
  string description = 3;
  repeated Resource resources = 4;
  ActorResource actor_resource = 5;
  map<string, string> attributes = 6;
  PolicySpecificationType specification_type = 7;
}

// Resource models a namespace for objects in a Policy.
// Appications will have multiple entities which they must manage such as files or groups.
// A Resource represents a set of entities of a certain type.
message Resource {
  string name = 1;
  string doc = 2;
  repeated Permission permissions = 3;
  repeated Relation relations = 4;
  repeated ManagementRule management_rules = 5;
  // owner models a special relation which is added to all resources.
  // It is used to represent the owner of some object in the system
  Relation owner = 6;
}

message Relation {
  string name = 1;

  string doc = 2;

  // list of relations managed by the current relation
  repeated string manages = 3;

  // value restriction types
  repeated Restriction vr_types = 4;
}

// Restriction models a specification which a Relationship's actor
// should meet.
message Restriction {
  // resource_name scopes permissible actors resource
  string resource_name = 1;
  // relation_name scopes permissible actors relation
  string relation_name = 2;
}

// Permission models a special type of Relation which is evaluated at runtime.
// A permission often maps to an operation defined for a resource which an actor may attempt.
message Permission {
  // name is an user defined identifier which uniquely identifies a permission within a resource
  string name = 1;
  // doc is an user defined string explaining the permission
  string doc = 2;
  // expression is a user defined permission expression, which follows the permission expression
  // grammar and models the evaluation steps which should b taken by the permission
  string expression = 3;

  // effective_expression is the engine define expression which will be used to compute the permission.
  // the effective expression may differ from the user expression due to internal acp engine
  // behavior enforcement, policy spec definitions and other policy behavior transforming
  // mechanisms.
  string effective_expression = 4;
}

// ActorResource represents a special Resource which is reserved for Policy actors.
message ActorResource {
  string name = 1;
  string doc = 2;
  repeated Relation relations = 3;
}

// ManagementRule models a policy rule which specifies the set of accepted relations
// an actor must have in order to modify relationships for an object
//
// This allows object owners, through a special management rule, to delegate
// the ability of creating relationships with a given relation to their object
message ManagementRule {
  // relation identifies relation the rule applies to 
  string relation = 1;
  // managers are the set of relation names which have authority to
  // manage relation instances of the relation the rule applies to.
  repeated string managers = 2;
  // expression is a zanzi compatible relation expression
  // which represents the management rule
  string expression = 3;
}